<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Delivery Map Pro - All-in-One HTML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{ --card:#fff; --bg:#f5f7fb; --text:#111; --muted:#666; --primary:#111; }
    html,body{ height:100%; }
    body{ margin:0; font-family: Segoe UI, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .topbar{ background:#111; color:#fff; padding:14px 10px; text-align:center; font-size:20px; font-weight:700; }
    .container{ max-width:1100px; margin:auto; padding:20px; }
    .card{ background:var(--card); border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    input,select{ width:100%; padding:10px; margin:8px 0; border:1px solid #ddd; border-radius:6px; font-size:14px; }
    button{ padding:10px 14px; border:none; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer; margin-right:6px; }
    button:hover{ background:#333; }
    #map{ height:420px; border-radius:12px; }

    .hidden{ display:none; }
    .success{ color:green; font-weight:600; }
    .error{ color:red; font-weight:600; }
    .flex{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .flex > *{ min-width:0; }

    /* Extra UI niceties */
    .status{ font-size:12px; color:var(--muted); margin-left:6px; }
    #authMsg, #saveMsg { min-height: 1.2em; margin-top:6px; }

    /* History panel styling */
    #historyPanel{ margin-top:8px; }
    #historyList{ display:flex; flex-direction:column; gap:8px; }
    .historyItem{ border:1px solid #e5e5e5; padding:8px; border-radius:8px; background:#fafafa; }
  </style>
</head>
<body>

  <div class="topbar">ðŸšš Delivery Map Pro</div>

  <div class="container">

    <!-- Auth Card -->
    <div id="authCard" class="card">
      <h3>Login</h3>
      <input type="email" id="loginEmail" placeholder="Email" autocomplete="username" />
      <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" />
      <div class="flex">
        <button id="loginBtn">Login</button>
        <button id="registerBtn" title="Create a new account">Register</button>
      </div>
      <div id="authMsg"></div>
    </div>

    <!-- App (hidden until login) -->
    <div id="app" class="hidden">

      <div class="card">
        <div class="flex" style="justify-content:space-between; align-items:center;">
          <div class="flex" style="gap:10px; align-items:center;">
            <button id="logoutBtn">Logout</button>
            <span class="status" id="loginStatus">Offline</span>
          </div>
          <div id="locationStatus" class="status" title="Live location status">Live location: Off</div>
        </div>
        <h3>Add / Update Delivery</h3>

        <input type="text" id="mobileInput" placeholder="Mobile Number" />
        <input type="text" id="addressInput" placeholder="Full Address" />
        <select id="statusSelect">
          <option value="Pending">Pending</option>
          <option value="Delivered">Delivered</option>
          <option value="Returned">Returned</option>
        </select>
        <input type="text" id="noteInput" placeholder="Note (optional)" />

        <div class="flex">
          <button id="saveBtn">Save / Update</button>
          <button id="deleteBtn" style="background:#c0392b;">Delete</button>
        </div>
        <div id="saveMsg"></div>
      </div>

      <!-- Search section -->
      <div class="card">
        <h3>Search (Single)</h3>
        <input type="text" id="searchInput" placeholder="Mobile Number" />
        <button id="searchBtn">Search</button>
      </div>

      <!-- History + Details -->
      <div id="historyPanel" class="card hidden">
        <h3>Delivery History for: <span id="historyMobile"></span></h3>
        <div id="historyList"></div>
      </div>

      <!-- Map -->
      <div id="map" class="card"></div>

    </div>

  </div>

  <script type="module">

    // Firebase 9+ (modular) imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // NOTE: Replace with your actual Firebase config. (Keep in mind this is public in a client app.)
    const firebaseConfig = {
      apiKey: "AIzaSyA82YWF574aCnkYdwN0airAcFl-_M21sHM",
      authDomain: "delivery-map-pro.firebaseapp.com",
      projectId: "delivery-map-pro",
      storageBucket: "delivery-map-pro.appspot.com",
      messagingSenderId: "544868009171",
      appId: "1:544868009171:web:005b3e95248eac940b8026"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI references
    const authCard = document.getElementById("authCard");
    const appDiv = document.getElementById("app");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const authMsg = document.getElementById("authMsg");

    const logoutBtn = document.getElementById("logoutBtn");
    const loginStatus = document.getElementById("loginStatus");
    const locationStatus = document.getElementById("locationStatus");

    const mobileInput = document.getElementById("mobileInput");
    const addressInput = document.getElementById("addressInput");
    const statusSelect = document.getElementById("statusSelect");
    const noteInput = document.getElementById("noteInput");
    const saveMsg = document.getElementById("saveMsg");

    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");

    const historyPanel = document.getElementById("historyPanel");
    const historyMobile = document.getElementById("historyMobile");
    const historyList = document.getElementById("historyList");

    // Map state
    let map;
    let userMarker;
    let currentLat = null;
    let currentLng = null;
    let watchId = null;
    let deliveryMarker = null;

    // Auto-prefill default login credentials (as requested)
    window.addEventListener("load", () => {
      // Default credentials (you asked for these). You can remove this in production.
      loginEmail.value = "streetfast@gmail.com";
      loginPassword.value = "Street@123";
      // Focus password for quick login
      // loginPassword.focus();
    });

    // Initialize the map (after login)
    function initMap(){
      // If map already exists, do not recreate
      if (map) return;

      // Start with a conservative default location; we'll recenter on user location
      map = L.map('map').setView([23.8103, 90.4125], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }

    // Start live location tracking
    function startLocationTracking(){
      if (!("geolocation" in navigator)){
        locationStatus.textContent = "Live location: Not available in this browser";
        return;
      }

      // If we already have a watcher, skip creating another
      if (watchId !== null) return;

      // Try to watch position with high accuracy
      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          currentLat = lat;
          currentLng = lng;

          // Create or move the user marker
          if (!userMarker){
            userMarker = L.marker([lat, lng]).addTo(map)
              .bindPopup("ðŸ“ Your Location").openPopup();
            map.setView([lat, lng], 15);
          } else {
            userMarker.setLatLng([lat, lng]);
          }

          // Optional: animate map to follow user on movement
          // map.panTo([lat, lng], { animate: true, duration: 0.25 });

          // Update the login/status text
          loginStatus.textContent = "Online";
          locationStatus.textContent = "Live location: On";

        },
        (err) => {
          // Handle permission denied or other errors gracefully
          console.warn("Geolocation error:", err);
          if (err.code === err.PERMISSION_DENIED){
            locationStatus.textContent = "Live location: Permission denied";
          } else {
            locationStatus.textContent = "Live location: Error getting position";
          }
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    }

    // Stop live location tracking (on sign-out)
    function stopLocationTracking(){
      if (watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (userMarker){
        // Do not remove the marker; keep showing current device location if user is logged out
        // You can optionally remove or keep it depending on UX
      }
      locationStatus.textContent = "Live location: Off";
      loginStatus.textContent = "Offline";
      currentLat = null;
      currentLng = null;
    }

    // Auth state handling
    onAuthStateChanged(auth, (user) => {
      if (user){
        // User is signed in
        authCard.classList.add("hidden");
        appDiv.classList.remove("hidden");

        // Init map (after login)
        initMap();
        // Start live location tracking
        startLocationTracking();

        loginStatus.textContent = "Online";

      } else {
        // User is signed out
        appDiv.classList.add("hidden");
        authCard.classList.remove("hidden");

        // Stop watchers and clear UI
        stopLocationTracking();
        if (map){
          // Optionally reset view
          // map.setView([0,0], 2);
        }
      }
    });

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      try{
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
        authMsg.innerHTML = "<div class='success'>Login Successful</div>";
      }catch(e){
        authMsg.innerHTML = "<div class='error'>"+e.message+"</div>";
      }
    };

    // Register
    document.getElementById("registerBtn").onclick = async () => {
      try{
        await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
        authMsg.innerHTML = "<div class='success'>Registered Successfully</div>";
      }catch(e){
        authMsg.innerHTML = "<div class='error'>"+e.message+"</div>";
      }
    };

    // Logout
    logoutBtn.onclick = () => signOut(auth);

    // Save / Update delivery
    document.getElementById("saveBtn").onclick = async () => {
      try{
        // Basic validation
        if(!mobileInput.value.trim() || !addressInput.value.trim()){
          saveMsg.innerHTML = "<div class='error'>Please fill Mobile Number and Address</div>";
          return;
        }
        // Use current location if available
        let lat = currentLat;
        let lng = currentLng;

        // If we don't have a live location yet, try to fallback to userMarker
        if (lat == null && userMarker){
          const ll = userMarker.getLatLng();
          lat = ll.lat;
          lng = ll.lng;
        }

        const docRef = doc(db, "deliveries", mobileInput.value.trim());

        // Build entry
        const entry = {
          address: addressInput.value.trim(),
          status: statusSelect.value,
          note: (noteInput.value ?? "").trim(),
          lat, lng,
          updatedAt: Date.now(),
        };

        // Merge history array
        const existing = await getDoc(docRef);
        let history = [];
        if (existing.exists()){
          const data = existing.data();
          history = Array.isArray(data.history) ? data.history.slice() : [];
        }

        // Push new history entry
        history.push({
          address: entry.address,
          status: entry.status,
          note: entry.note,
          lat: entry.lat,
          lng: entry.lng,
          timestamp: Date.now()
        });

        // Write/merge
        await setDoc(docRef, {
          address: entry.address,
          status: entry.status,
          note: entry.note,
          lat: entry.lat,
          lng: entry.lng,
          updatedAt: entry.updatedAt,
          uid: auth.currentUser ? auth.currentUser.uid : null,
          history: history
        }, { merge: true });

        saveMsg.innerHTML = "<div class='success'>Saved Successfully âœ…</div>";

        // Optional: refresh search/history panel if needed
      }catch(e){
        saveMsg.innerHTML = "<div class='error'>"+e.message+"</div>";
      }
    };

    // Delete delivery
    document.getElementById("deleteBtn").onclick = async () => {
      try{
        const key = mobileInput.value.trim();
        if(!key){
          saveMsg.innerHTML = "<div class='error'>Enter a Mobile Number to delete</div>";
          return;
        }
        await deleteDoc(doc(db, "deliveries", key));
        saveMsg.innerHTML = "<div class='success'>Deleted</div>";

        // Clean up UI markers
        if (deliveryMarker){
          map.removeLayer(deliveryMarker);
          deliveryMarker = null;
        }
        // Clear history panel if it was showing
        historyPanel.classList.add("hidden");
        historyList.innerHTML = "";
        historyMobile.textContent = "";

      }catch(e){
        saveMsg.innerHTML = "<div class='error'>"+e.message+"</div>";
      }
    };

    // Search
    document.getElementById("searchBtn").onclick = async () => {
      try{
        const mobile = searchInput.value.trim();
        if(!mobile){
          alert("Please enter a Mobile Number to search");
          return;
        }
        const snap = await getDoc(doc(db, "deliveries", mobile));
        if(!snap.exists()){
          alert("Not Found");
          // Clear any existing marker/history if needed
          if (deliveryMarker){
            map.removeLayer(deliveryMarker);
            deliveryMarker = null;
          }
          historyPanel.classList.add("hidden");
          historyList.innerHTML = "";
          historyMobile.textContent = "";
          return;
        }
        const d = snap.data();

        // Show history panel
        historyPanel.classList.remove("hidden");
        historyMobile.textContent = mobile;

        // Render history
        const hist = Array.isArray(d.history) ? d.history : [];
        let html = '';
        if (hist.length === 0){
          html = "<div class='historyItem'>No history entries yet.</div>";
        } else {
          html = hist.map(h => {
            const t = new Date(h.timestamp || Date.now()).toLocaleString();
            return `<div class="historyItem">
              <div><strong>Time:</strong> ${t}</div>
              <div><strong>Address:</strong> ${h.address}</div>
              <div><strong>Status:</strong> ${h.status}</div>
              <div><strong>Note:</strong> ${h.note || ""}</div>
              <div><strong>Lat/Lng:</strong> ${h.lat ?? ""}, ${h.lng ?? ""}</div>
            </div>`;
          }).join('');
        }
        historyList.innerHTML = html;

        // Show marker for the saved location
        const lat = d.lat;
        const lng = d.lng;
        if (typeof lat === "number" && typeof lng === "number"){
          if (deliveryMarker) map.removeLayer(deliveryMarker);
          deliveryMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`<strong>${d.address}</strong><br/>Status: ${d.status}<br/>Note: ${d.note || ""}`).openPopup();
          map.setView([lat, lng], 15);
        } else {
          console.warn("Search result has no coordinates");
        }

      }catch(e){
        alert("Error during search: " + e.message);
      }
    };

  </script>
</body>
</html>
