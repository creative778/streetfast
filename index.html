<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Delivery Map Pro Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2;}
.topbar{background:#111;color:#fff;padding:15px;text-align:center;font-size:18px;}
.container{padding:15px;max-width:1000px;margin:auto;}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input,select,button{padding:10px;margin:5px 0;width:100%;border-radius:6px;border:1px solid #ccc;}
button{background:#111;color:#fff;border:none;cursor:pointer;}
button:hover{background:#333;}
#map{height:400px;margin-top:10px;border-radius:8px;}
.success{color:green;font-weight:bold;}
.error{color:red;font-weight:bold;}
.hidden{display:none;}
.smallbtn{width:auto;padding:6px 12px;margin-right:5px;}
</style>
</head>
<body>

<div class="topbar">ðŸšš Delivery Map Pro Ultimate</div>

<div class="container">

<div id="authBox" class="card">
<h3>Login / Register</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>
<div id="authMsg"></div>
</div>

<div id="mainPanel" class="hidden">

<div class="card">
<button onclick="logout()" class="smallbtn">Logout</button>
<h3>Add / Update Delivery</h3>
<input type="text" id="mobile" placeholder="Mobile Number">
<input type="text" id="address" placeholder="Full Address">
<select id="status">
<option>Pending</option>
<option>Delivered</option>
<option>Returned</option>
</select>
<input type="text" id="note" placeholder="Note">
<button onclick="saveDelivery()">Save / Update</button>
<button onclick="deleteDelivery()">Delete</button>
<div id="saveMsg"></div>
</div>

<div class="card">
<h3>Search Single</h3>
<input type="text" id="searchSingleMobile" placeholder="Mobile">
<button onclick="searchSingle()">Search</button>
</div>

<div class="card">
<h3>Search Multiple (comma separated)</h3>
<input type="text" id="searchMultiMobile" placeholder="017xx,018xx">
<button onclick="searchMultiple()">Search Multiple</button>
<div id="multiResult"></div>
</div>

<div id="map"></div>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyA82YWF574aCnkYdwN0airAcFl-_M21sHM",
authDomain: "delivery-map-pro.firebaseapp.com",
projectId: "delivery-map-pro",
storageBucket: "delivery-map-pro.firebasestorage.app",
messagingSenderId: "544868009171",
appId: "1:544868009171:web:005b3e95248eac940b8026"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let map=L.map('map').setView([23.8103,90.4125],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker;
let deliveryMarkers=[];
let userLat,userLng;

function startLiveLocation(){
if(!navigator.geolocation){
alert("Geolocation not supported");
return;
}

navigator.geolocation.watchPosition(position=>{
userLat=position.coords.latitude;
userLng=position.coords.longitude;

if(userMarker) map.removeLayer(userMarker);
userMarker=L.marker([userLat,userLng]).addTo(map)
.bindPopup("ðŸ“ Your Live Location");

map.setView([userLat,userLng],14);

},error=>{
alert("Location permission denied");
},{enableHighAccuracy:true});
}

map.on("click",e=>{
if(userMarker) return;
});

onAuthStateChanged(auth,user=>{
if(user){
authBox.classList.add("hidden");
mainPanel.classList.remove("hidden");
startLiveLocation();
}else{
authBox.classList.remove("hidden");
mainPanel.classList.add("hidden");
}
});

async function register(){
try{
await createUserWithEmailAndPassword(auth,email.value,password.value);
authMsg.innerHTML="<div class='success'>Registered Successfully</div>";
}catch(err){
authMsg.innerHTML="<div class='error'>"+err.message+"</div>";
}
}

async function login(){
try{
await signInWithEmailAndPassword(auth,email.value,password.value);
authMsg.innerHTML="<div class='success'>Login Successful</div>";
}catch(err){
authMsg.innerHTML="<div class='error'>"+err.message+"</div>";
}
}

async function logout(){
await signOut(auth);
}

async function saveDelivery(){
try{
if(!userMarker){
saveMsg.innerHTML="<div class='error'>Select location on map</div>";
return;
}
let latlng=userMarker.getLatLng();
await setDoc(doc(db,"deliveries",mobile.value.trim()),{
address:address.value.trim(),
status:status.value,
note:note.value,
lat:latlng.lat,
lng:latlng.lng,
createdBy:auth.currentUser.uid,
timestamp:Date.now()
});
saveMsg.innerHTML="<div class='success'>Saved Successfully âœ…</div>";
}catch(err){
saveMsg.innerHTML="<div class='error'>"+err.message+"</div>";
}
}

async function deleteDelivery(){
await deleteDoc(doc(db,"deliveries",mobile.value.trim()));
saveMsg.innerHTML="<div class='success'>Deleted Successfully</div>";
}

async function searchSingle(){
clearMarkers();
let snap=await getDoc(doc(db,"deliveries",searchSingleMobile.value.trim()));
if(!snap.exists()){alert("No Data");return;}
let d=snap.data();
let marker=L.marker([d.lat,d.lng]).addTo(map)
.bindPopup(d.address).openPopup();
deliveryMarkers.push(marker);
map.setView([d.lat,d.lng],15);
}

async function searchMultiple(){
clearMarkers();
let nums=searchMultiMobile.value.split(",");
let results=[];
for(let n of nums){
let snap=await getDoc(doc(db,"deliveries",n.trim()));
if(snap.exists()){
results.push({mobile:n.trim(),...snap.data()});
}
}

if(userLat){
results.sort((a,b)=>distance(userLat,userLng,a.lat,a.lng)-distance(userLat,userLng,b.lat,b.lng));
}

let html="";
results.forEach((r,i)=>{
let marker=L.marker([r.lat,r.lng]).addTo(map)
.bindPopup((i+1)+". "+r.address);
deliveryMarkers.push(marker);

html+=`<div class='card'>
<b>${i+1}. ${r.mobile}</b><br>
${r.address}<br>
<button onclick="goRoute(${r.lat},${r.lng})">Navigate</button>
</div>`;
});
multiResult.innerHTML=html;
if(deliveryMarkers.length>0)
map.fitBounds(deliveryMarkers.map(m=>m.getLatLng()));
}

function goRoute(lat,lng){
window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
}

function clearMarkers(){
deliveryMarkers.forEach(m=>map.removeLayer(m));
deliveryMarkers=[];
}

function distance(lat1,lon1,lat2,lon2){
let R=6371;
let dLat=(lat2-lat1)*Math.PI/180;
let dLon=(lon2-lon1)*Math.PI/180;
let a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

window.searchMultiple=searchMultiple;
window.searchSingle=searchSingle;
window.saveDelivery=saveDelivery;
window.deleteDelivery=deleteDelivery;
window.goRoute=goRoute;
window.login=login;
window.register=register;
window.logout=logout;

</script>
</body>
</html>
