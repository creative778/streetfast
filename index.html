<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>StreetFast Delivery Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#f4f6fb;}
.topbar{background:#111;color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:600;}
.container{max-width:1100px;margin:auto;padding:20px;}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);}
input,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:8px;font-size:14px;}
button{padding:10px 15px;border:none;border-radius:8px;background:#111;color:#fff;cursor:pointer;}
button:hover{background:#333;}
#map{height:450px;border-radius:12px;}
.success{color:green;font-weight:600;}
.error{color:red;font-weight:600;}
.hidden{display:none;}
.detailsBox{background:#eef2ff;padding:15px;border-radius:10px;margin-top:10px;}
</style>
</head>
<body>

<div class="topbar">ðŸšš StreetFast Delivery Pro</div>

<div class="container">

<div id="app">

<div class="card">
<h3>Add / Update Delivery</h3>

<input type="text" id="mobileField" placeholder="Mobile Number">
<input type="text" id="addressField" placeholder="Full Address">

<select id="statusField">
<option value="Pending">Pending</option>
<option value="Delivered">Delivered</option>
<option value="Returned">Returned</option>
</select>

<input type="text" id="noteField" placeholder="Note">

<button id="saveBtn">Save / Update</button>
<button id="deleteBtn">Delete</button>

<div id="saveMsg"></div>
<p><b>Click map to select pickup/delivery location</b></p>
</div>

<div class="card">
<h3>Search Delivery</h3>
<input type="text" id="searchField">
<button id="searchBtn">Search</button>
<div id="details"></div>
</div>

<div id="map"></div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyA82YWF574aCnkYdwN0airAcFl-_M21sHM",
authDomain: "delivery-map-pro.firebaseapp.com",
projectId: "delivery-map-pro",
storageBucket: "delivery-map-pro.firebasestorage.app",
messagingSenderId: "544868009171",
appId: "1:544868009171:web:005b3e95248eac940b8026"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let map = L.map('map').setView([23.8103,90.4125],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let selectedLat = null;
let selectedLng = null;
let deliveryMarker;

navigator.geolocation.watchPosition(pos=>{
let lat = pos.coords.latitude;
let lng = pos.coords.longitude;

L.marker([lat,lng]).addTo(map)
.bindPopup("ðŸ“ Your Live Location");

map.setView([lat,lng],14);

},{enableHighAccuracy:true});

map.on("click",e=>{
selectedLat = e.latlng.lat;
selectedLng = e.latlng.lng;

if(deliveryMarker) map.removeLayer(deliveryMarker);

deliveryMarker = L.marker([selectedLat,selectedLng])
.addTo(map)
.bindPopup("ðŸ“¦ Selected Location")
.openPopup();
});

document.getElementById("saveBtn").onclick = async ()=>{
const mobile = document.getElementById("mobileField").value.trim();
const address = document.getElementById("addressField").value.trim();
const statusValue = document.getElementById("statusField").value;
const note = document.getElementById("noteField").value.trim();

if(!mobile || !address || selectedLat===null){
document.getElementById("saveMsg").innerHTML="<div class='error'>Fill all fields & select location</div>";
return;
}

try{
await setDoc(doc(db,"deliveries",mobile),{
address: address,
status: statusValue,
note: note,
lat: selectedLat,
lng: selectedLng,
updatedAt: Date.now()
});
document.getElementById("saveMsg").innerHTML="<div class='success'>Saved Successfully âœ…</div>";
}catch(e){
document.getElementById("saveMsg").innerHTML="<div class='error'>"+e.message+"</div>";
}
};

document.getElementById("deleteBtn").onclick = async ()=>{
const mobile = document.getElementById("mobileField").value.trim();
if(!mobile) return;
await deleteDoc(doc(db,"deliveries",mobile));
document.getElementById("saveMsg").innerHTML="<div class='success'>Deleted</div>";
};

document.getElementById("searchBtn").onclick = async ()=>{
const mobile = document.getElementById("searchField").value.trim();
let snap = await getDoc(doc(db,"deliveries",mobile));
if(!snap.exists()){
document.getElementById("details").innerHTML="<div class='error'>Not Found</div>";
return;
}
let d = snap.data();

if(deliveryMarker) map.removeLayer(deliveryMarker);
deliveryMarker = L.marker([d.lat,d.lng])
.addTo(map)
.bindPopup("ðŸ“¦ Delivery Location")
.openPopup();

map.setView([d.lat,d.lng],15);

document.getElementById("details").innerHTML=`
<div class="detailsBox">
<b>Mobile:</b> ${mobile}<br>
<b>Address:</b> ${d.address}<br>
<b>Status:</b> ${d.status}<br>
<b>Note:</b> ${d.note}<br>
<b>Last Update:</b> ${new Date(d.updatedAt).toLocaleString()}
</div>`;
};

</script>
</body>
</html>
