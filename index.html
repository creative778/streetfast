<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Map Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; min-height: 100vh; }
.topbar { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; padding: 18px; text-align: center; font-size: 22px; font-weight: 700; letter-spacing: 1px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.topbar span { margin-right: 8px; }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.card { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
.card h3 { color: #1a1a2e; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 2px solid #eef2f7; }

.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-weight: 600; color: #444; margin-bottom: 6px; font-size: 14px; }
input, select, textarea { width: 100%; padding: 12px 15px; margin: 8px 0; border: 2px solid #e1e5eb; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
textarea { resize: vertical; min-height: 80px; }

.btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
.btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: #fff; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(79,70,229,0.4); }
.btn-secondary { background: #6b7280; color: #fff; }
.btn-secondary:hover { background: #4b5563; }
.btn-danger { background: #ef4444; color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-success { background: #10b981; color: #fff; }
.btn-success:hover { background: #059669; }
.btn-outline { background: transparent; border: 2px solid #4f46e5; color: #4f46e5; }
.btn-outline:hover { background: #4f46e5; color: #fff; }
.btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
.btn-group .btn { flex: 1; min-width: 120px; justify-content: center; }

.status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; }
.status-pending { background: #fef3c7; color: #d97706; }
.status-delivered { background: #d1fae5; color: #059669; }
.status-returned { background: #fee2e2; color: #dc2626; }

#map { height: 500px; border-radius: 12px; margin-top: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

.message { padding: 12px 16px; border-radius: 8px; margin: 10px 0; font-weight: 500; }
.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
.warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }

.auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
.auth-card { max-width: 420px; width: 100%; }
.auth-card .logo { text-align: center; margin-bottom: 30px; }
.auth-card .logo h2 { color: #1a1a2e; font-size: 28px; }
.auth-card .logo p { color: #6b7280; margin-top: 5px; }

.location-controls { display: flex; gap: 10px; margin: 10px 0; align-items: center; flex-wrap: wrap; }
.location-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6b7280; }
.dot { width: 10px; height: 10px; border-radius: 50%; background: #9ca3af; }
.dot.active { background: #10b981; animation: pulse 2s infinite; }
.dot.error { background: #ef4444; }

.search-tags { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
.search-tag { background: #e0e7ff; color: #4f46e5; padding: 6px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
.search-tag .remove { cursor: pointer; font-weight: bold; }
.search-tag.not-found { background: #fee2e2; color: #dc2626; }

.results-list { max-height: 400px; overflow-y: auto; margin-top: 15px; }
.result-item { padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; background: #f9fafb; }
.result-item:hover { background: #f3f4f6; }
.result-item .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.result-item .mobile { font-weight: 700; color: #1a1a2e; font-size: 16px; }
.result-item .address { color: #6b7280; margin: 5px 0; }
.result-item .meta { font-size: 12px; color: #9ca3af; }

.hidden { display: none !important; }
.flex { display: flex; gap: 10px; flex-wrap: wrap; }
.mt-10 { margin-top: 10px; }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

@media (max-width: 768px) {
  .container { padding: 15px; }
  .card { padding: 18px; }
  #map { height: 350px; }
  .btn-group .btn { min-width: 100%; }
}
</style>
</head>
<body>

<div class="topbar">
  <span>üöö</span> Delivery Map Pro
</div>

<div class="container">

<!-- Login Panel -->
<div id="authCard" class="card auth-wrapper">
  <div class="auth-card">
    <div class="logo">
      <h2>üöö Delivery Map Pro</h2>
      <p>Secure Delivery Management</p>
    </div>
    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="loginEmail" placeholder="Enter your email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter your password">
    </div>
    <div class="btn-group">
      <button id="loginBtn" class="btn btn-primary" style="flex:2">üîë Login</button>
      <button id="registerBtn" class="btn btn-outline" style="flex:1">Register</button>
    </div>
    <div id="authMsg"></div>
  </div>
</div>

<!-- Main App -->
<div id="app" class="hidden">

<!-- Header -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
    <div>
      <h3 style="margin:0;border:none;padding:0;">Welcome, <span id="userEmail" style="color:#4f46e5;"></span></h3>
    </div>
    <button id="logoutBtn" class="btn btn-danger">üö™ Logout</button>
  </div>
  
  <div class="location-controls mt-10">
    <div class="location-status">
      <span class="dot" id="locationDot"></span>
      <span id="locationStatusText">Location: Checking...</span>
    </div>
    <button id="refreshLocationBtn" class="btn btn-secondary" style="padding:8px 15px;font-size:13px;">üîÑ Refresh</button>
  </div>
</div>

<!-- Add/Update Delivery -->
<div class="card">
  <h3>üì¶ Add / Update Delivery</h3>
  
  <div class="flex" style="gap:15px;">
    <div style="flex:1;min-width:250px;">
      <div class="form-group">
        <label>Mobile Number *</label>
        <input type="tel" id="mobileInput" placeholder="01XXXXXXXXX">
      </div>
    </div>
    <div style="flex:1;min-width:250px;">
      <div class="form-group">
        <label>Delivery Status</label>
        <select id="statusSelect">
          <option value="Pending">‚è≥ Pending</option>
          <option value="Delivered">‚úÖ Delivered</option>
          <option value="Returned">‚Ü©Ô∏è Returned</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="form-group">
    <label>Full Address *</label>
    <input type="text" id="addressInput" placeholder="Enter complete delivery address">
  </div>
  
  <div class="form-group">
    <label>üìç Pickup Location (Click map or use button)</label>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <input type="text" id="pickupLat" placeholder="Latitude" style="flex:1;min-width:120px;" readonly>
      <input type="text" id="pickupLng" placeholder="Longitude" style="flex:1;min-width:120px;" readonly>
      <button id="getPickupLocationBtn" class="btn btn-secondary">üìç Get Current</button>
    </div>
    <small style="color:#6b7280;">üí° Tip: Click on the map to select pickup location</small>
  </div>
  
  <div class="form-group">
    <label>Delivery Notes</label>
    <textarea id="noteInput" placeholder="Any special instructions..."></textarea>
  </div>
  
  <div class="btn-group">
    <button id="saveBtn" class="btn btn-success">üíæ Save / Update</button>
    <button id="clearFormBtn" class="btn btn-secondary">‚ú® Clear Form</button>
    <button id="deleteBtn" class="btn btn-danger">üóëÔ∏è Delete</button>
  </div>
  <div id="saveMsg"></div>
</div>

<!-- Single Search -->
<div class="card">
  <h3>üîç Single Search</h3>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <input type="tel" id="singleSearchInput" placeholder="Enter mobile number" style="flex:1;min-width:200px;">
    <button id="singleSearchBtn" class="btn btn-primary">Search</button>
  </div>
  <div id="singleSearchResult"></div>
</div>

<!-- Multiple Search -->
<div class="card">
  <h3>üìã Multiple Search</h3>
  <div class="form-group">
    <label>Enter multiple mobile numbers (comma or space separated)</label>
    <input type="text" id="multiSearchInput" placeholder="e.g., 01712345678, 01812345679, 01912345670">
  </div>
  <div class="btn-group">
    <button id="multiSearchBtn" class="btn btn-primary">üîç Search All</button>
    <button id="clearSearchBtn" class="btn btn-secondary">Clear List</button>
  </div>
  
  <div id="searchTags" class="search-tags hidden"></div>
  <div id="multiSearchResults" class="results-list"></div>
</div>

<!-- Map -->
<div class="card">
  <h3>üó∫Ô∏è Live Map</h3>
  <div id="map"></div>
</div>

</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA82YWF574aCnkYdwN0airAcFl-_M21sHM",
  authDomain: "delivery-map-pro.firebaseapp.com",
  projectId: "delivery-map-pro",
  storageBucket: "delivery-map-pro.firebasestorage.app",
  messagingSenderId: "544868009171",
  appId: "1:544868009171:web:005b3e95248eac940b8026"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const authCard = document.getElementById("authCard");
const appDiv = document.getElementById("app");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const authMsg = document.getElementById("authMsg");
const userEmail = document.getElementById("userEmail");
const locationDot = document.getElementById("locationDot");
const locationStatusText = document.getElementById("locationStatusText");

const mobileInput = document.getElementById("mobileInput");
const addressInput = document.getElementById("addressInput");
const statusSelect = document.getElementById("statusSelect");
const noteInput = document.getElementById("noteInput");
const pickupLat = document.getElementById("pickupLat");
const pickupLng = document.getElementById("pickupLng");
const saveMsg = document.getElementById("saveMsg");

let map;
let userMarker = null;
let pickupMarker = null;
let deliveryMarkers = [];
let watchId = null;
let currentPosition = null;

// ==================== MAP ====================
function initMap() {
  if (map) map.remove();
  
  map = L.map('map').setView([23.8103, 90.4125], 12);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);
  
  // Click on map to set pickup location
  map.on('click', function(e) {
    pickupLat.value = e.latlng.lat.toFixed(6);
    pickupLng.value = e.latlng.lng.toFixed(6);
    setPickupMarker(e.latlng.lat, e.latlng.lng);
    saveMsg.innerHTML = '<div class="message info">üìç Pickup location set! Click again to change.</div>';
  });
  
  requestLocation();
}

function setPickupMarker(lat, lng) {
  if (pickupMarker) map.removeLayer(pickupMarker);
  
  pickupMarker = L.marker([lat, lng], {
    draggable: true
  }).addTo(map).bindPopup("üìç Pickup Location").openPopup();
  
  pickupMarker.on('dragend', function(e) {
    const pos = e.target.getLatLng();
    pickupLat.value = pos.lat.toFixed(6);
    pickupLng.value = pos.lng.toFixed(6);
  });
}

// ==================== LOCATION ====================
function requestLocation() {
  if (!navigator.geolocation) {
    updateLocationStatus(false, "Geolocation not supported");
    return;
  }
  
  updateLocationStatus(false, "Getting location...");
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      updateUserMarker(currentPosition);
      updateLocationStatus(true, "Location active");
      startWatchLocation();
    },
    (error) => {
      let msg = "Location error";
      if (error.code === 1) msg = "Permission denied - Please allow location";
      else if (error.code === 2) msg = "Position unavailable";
      else if (error.code === 3) msg = "Timeout";
      updateLocationStatus(false, msg);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function startWatchLocation() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  
  watchId = navigator.geolocation.watchPosition(
    (position) => {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      updateUserMarker(currentPosition);
      updateLocationStatus(true, "Live tracking active");
    },
    (error) => { console.log("Watch error:", error.message); },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
  );
}

function updateUserMarker(pos) {
  if (!map) return;
  
  if (userMarker) {
    userMarker.setLatLng([pos.lat, pos.lng]);
  } else {
    const userIcon = L.divIcon({
      html: '<div style="background:#4f46e5;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
      iconSize: [20, 20], iconAnchor: [10, 10]
    });
    
    userMarker = L.marker([pos.lat, pos.lng], { icon: userIcon })
      .addTo(map)
      .bindPopup("<b>üìç My Location</b>").openPopup();
  }
  
  map.setView([pos.lat, pos.lng], 14);
}

function updateLocationStatus(active, text) {
  locationDot.className = 'dot ' + (active ? 'active' : 'error');
  locationStatusText.textContent = text;
}

// ==================== AUTH ====================
let isFirstLoad = true;

onAuthStateChanged(auth, (user) => {
  if (isFirstLoad) {
    isFirstLoad = false;
    return;
  }
  
  if (user) {
    authCard.classList.add("hidden");
    appDiv.classList.remove("hidden");
    userEmail.textContent = user.email;
    setTimeout(initMap, 300);
  } else {
    authCard.classList.remove("hidden");
    appDiv.classList.add("hidden");
    userEmail.textContent = "";
  }
});

document.getElementById("loginBtn").onclick = async () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value;
  
  if (!email || !password) {
    authMsg.innerHTML = '<div class="message error">Please enter email and password</div>';
    return;
  }
  
  authMsg.innerHTML = '<div class="message info">Logging in...</div>';
  
  try {
    await signInWithEmailAndPassword(auth, email, password);
    authMsg.innerHTML = '<div class="message success">‚úì Login Successful!</div>';
    loginEmail.value = '';
    loginPassword.value = '';
  } catch (error) {
    console.error("Login error:", error);
    let msg = error.message;
    if (error.code === 'auth/invalid-email') msg = 'Invalid email';
    else if (error.code === 'auth/user-not-found') msg = 'User not found';
    else if (error.code === 'auth/wrong-password') msg = 'Wrong password';
    else if (error.code === 'auth/invalid-credential') msg = 'Invalid credentials';
    authMsg.innerHTML = `<div class="message error">${msg}</div>`;
  }
};

document.getElementById("registerBtn").onclick = async () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value;
  
  if (!email || !password) {
    authMsg.innerHTML = '<div class="message error">Enter email and password</div>';
    return;
  }
  
  if (password.length < 6) {
    authMsg.innerHTML = '<div class="message error">Password must be 6+ characters</div>';
    return;
  }
  
  authMsg.innerHTML = '<div class="message info">Creating account...</div>';
  
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    authMsg.innerHTML = '<div class="message success">‚úì Account created!</div>';
    loginEmail.value = '';
    loginPassword.value = '';
  } catch (error) {
    console.error("Register error:", error);
    let msg = error.message;
    if (error.code === 'auth/email-already-in-use') msg = 'Email already exists';
    else if (error.code === 'auth/invalid-email') msg = 'Invalid email';
    authMsg.innerHTML = `<div class="message error">${msg}</div>`;
  }
};

document.getElementById("logoutBtn").onclick = async () => {
  try {
    await signOut(auth);
  } catch (e) { console.error(e); }
};

document.getElementById("refreshLocationBtn").onclick = requestLocation;

document.getElementById("getPickupLocationBtn").onclick = () => {
  if (currentPosition) {
    pickupLat.value = currentPosition.lat.toFixed(6);
    pickupLng.value = currentPosition.lng.toFixed(6);
    setPickupMarker(currentPosition.lat, currentPosition.lng);
    saveMsg.innerHTML = '<div class="message success">Current location set!</div>';
  } else {
    saveMsg.innerHTML = '<div class="message error">Location not available. Please allow location permission.</div>';
  }
};

// ==================== SAVE ====================
document.getElementById("saveBtn").onclick = async () => {
  const mobile = mobileInput.value.trim();
  const address = addressInput.value.trim();
  const status = statusSelect.value;
  const note = noteInput.value.trim();
  const lat = pickupLat.value ? parseFloat(pickupLat.value) : null;
  const lng = pickupLng.value ? parseFloat(pickupLng.value) : null;
  
  if (!mobile) {
    saveMsg.innerHTML = '<div class="message error">Mobile number required!</div>';
    return;
  }
  
  if (!address) {
    saveMsg.innerHTML = '<div class="message error">Address required!</div>';
    return;
  }
  
  saveMsg.innerHTML = '<div class="message info">Saving...</div>';
  
  try {
    await setDoc(doc(db, "deliveries", mobile), {
      address, status, note, lat, lng,
      uid: auth.currentUser.uid,
      updatedAt: Date.now()
    });
    
    saveMsg.innerHTML = '<div class="message success">‚úì Saved: ' + mobile + '</div>';
    
    if (lat && lng) {
      showDeliveryOnMap(lat, lng, address, status);
    }
    
  } catch (error) {
    saveMsg.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
  }
};

document.getElementById("clearFormBtn").onclick = () => {
  mobileInput.value = '';
  addressInput.value = '';
  statusSelect.value = 'Pending';
  noteInput.value = '';
  pickupLat.value = '';
  pickupLng.value = '';
  saveMsg.innerHTML = '';
  if (pickupMarker) {
    map.removeLayer(pickupMarker);
    pickupMarker = null;
  }
};

document.getElementById("deleteBtn").onclick = async () => {
  const mobile = mobileInput.value.trim();
  if (!mobile) {
    saveMsg.innerHTML = '<div class="message error">Enter mobile to delete</div>';
    return;
  }
  if (!confirm('Delete ' + mobile + '?')) return;
  
  try {
    await deleteDoc(doc(db, "deliveries", mobile));
    saveMsg.innerHTML = '<div class="message success">Deleted!</div>';
    document.getElementById("clearFormBtn").click();
  } catch (e) {
    saveMsg.innerHTML = '<div class="message error">Error: ' + e.message + '</div>';
  }
};

// ==================== SINGLE SEARCH ====================
document.getElementById("singleSearchBtn").onclick = async () => {
  const mobile = document.getElementById("singleSearchInput").value.trim();
  const resultDiv = document.getElementById("singleSearchResult");
  
  if (!mobile) {
    resultDiv.innerHTML = '<div class="message error">Enter mobile number</div>';
    return;
  }
  
  try {
    const snap = await getDoc(doc(db, "deliveries", mobile));
    
    if (!snap.exists()) {
      resultDiv.innerHTML = '<div class="message warning">‚ö†Ô∏è Not found: ' + mobile + '</div>';
      return;
    }
    
    const d = snap.data();
    
    // Fill form
    mobileInput.value = mobile;
    addressInput.value = d.address || '';
    statusSelect.value = d.status || 'Pending';
    noteInput.value = d.note || '';
    pickupLat.value = d.lat || '';
    pickupLng.value = d.lng || '';
    
    let statusClass = 'status-' + (d.status || 'pending').toLowerCase();
    
    resultDiv.innerHTML = `
      <div class="message success">
        <strong>‚úì Found: ${mobile}</strong><br>
        üìç ${d.address}<br>
        üìä Status: <span class="status-badge ${statusClass}">${d.status}</span><br>
        üìù ${d.note || 'No notes'}
      </div>
    `;
    
    if (d.lat && d.lng) {
      showDeliveryOnMap(d.lat, d.lng, d.address, d.status);
    }
    
  } catch (e) {
    resultDiv.innerHTML = '<div class="message error">Error: ' + e.message + '</div>';
  }
};

// ==================== MULTIPLE SEARCH ====================
let searchList = [];

document.getElementById("multiSearchBtn").onclick = async () => {
  const input = document.getElementById("multiSearchInput").value.trim();
  const resultsDiv = document.getElementById("multiSearchResults");
  const tagsDiv = document.getElementById("searchTags");
  
  if (!input) {
    resultsDiv.innerHTML = '<div class="message error">Enter mobile numbers</div>';
    return;
  }
  
  // Parse numbers
  const numbers = input.split(/[\s,]+/).filter(n => n.length > 0);
  searchList = [...new Set(numbers)]; // Remove duplicates
  
  if (searchList.length === 0) return;
  
  // Show tags
  tagsDiv.classList.remove('hidden');
  tagsDiv.innerHTML = searchList.map(n => 
    `<span class="search-tag" data-mobile="${n}">${n} <span class="remove" onclick="removeSearchTag('${n}')">√ó</span></span>`
  ).join('');
  
  resultsDiv.innerHTML = '<div class="message info">Searching ' + searchList.length + ' numbers...</div>';
  
  let found = [];
  let notFound = [];
  
  for (let mobile of searchList) {
    try {
      const snap = await getDoc(doc(db, "deliveries", mobile));
      
      if (snap.exists()) {
        found.push({ mobile, data: snap.data() });
      } else {
        notFound.push(mobile);
      }
    } catch (e) {
      notFound.push(mobile);
    }
  }
  
  // Update tags for not found
  notFound.forEach(n => {
    const tag = document.querySelector(`.search-tag[data-mobile="${n}"]`);
    if (tag) tag.classList.add('not-found');
  });
  
  // Show results
  let html = '';
  
  if (notFound.length > 0) {
    html += `<div class="message warning">‚ö†Ô∏è Not Found (${notFound.length}): ${notFound.join(', ')}</div>`;
  }
  
  if (found.length > 0) {
    html += `<div class="message success">‚úì Found (${found.length}):</div>`;
    
    found.forEach(item => {
      const d = item.data;
      const statusClass = 'status-' + (d.status || 'pending').toLowerCase();
      
      html += `
        <div class="result-item" onclick="loadDelivery('${item.mobile}')">
          <div class="header">
            <span class="mobile">üì± ${item.mobile}</span>
            <span class="status-badge ${statusClass}">${d.status}</span>
          </div>
          <div class="address">üìç ${d.address}</div>
          <div class="meta">üìù ${d.note || 'No notes'} | üìç ${d.lat ? d.lat.toFixed(4) + ',' + d.lng.toFixed(4) : 'No location'}</div>
        </div>
      `;
    });
    
    // Show first found on map
    if (found[0].data.lat && found[0].data.lng) {
      showDeliveryOnMap(found[0].data.lat, found[0].data.lng, found[0].data.address, found[0].data.status);
    }
  } else if (notFound.length === searchList.length) {
    html += '<div class="message error">No deliveries found!</div>';
  }
  
  resultsDiv.innerHTML = html;
};

document.getElementById("clearSearchBtn").onclick = () => {
  document.getElementById("multiSearchInput").value = '';
  document.getElementById("searchTags").innerHTML = '';
  document.getElementById("searchTags").classList.add('hidden');
  document.getElementById("multiSearchResults").innerHTML = '';
  searchList = [];
};

window.removeSearchTag = function(mobile) {
  searchList = searchList.filter(n => n !== mobile);
  document.getElementById("searchTags").innerHTML = searchList.map(n => 
    `<span class="search-tag" data-mobile="${n}">${n} <span class="remove" onclick="removeSearchTag('${n}')">√ó</span></span>`
  ).join('');
};

window.loadDelivery = function(mobile) {
  document.getElementById("singleSearchInput").value = mobile;
  document.getElementById("singleSearchBtn").click();
};

function showDeliveryOnMap(lat, lng, address, status) {
  if (!map) return;
  
  deliveryMarkers.forEach(m => map.removeLayer(m));
  deliveryMarkers = [];
  
  let color = '#f59e0b';
  if (status === 'Delivered') color = '#10b981';
  else if (status === 'Returned') color = '#ef4444';
  
  const icon = L.divIcon({
    html: `<div style="background:${color};width:28px;height:28px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">üì¶</div>`,
    iconSize: [28, 28], iconAnchor: [14, 14]
  });
  
  const marker = L.marker([lat, lng], { icon: icon })
    .addTo(map)
    .bindPopup(`<b>${status}</b><br>${address}`)
    .openPopup();
  
  deliveryMarkers.push(marker);
  map.setView([lat, lng], 16);
}

// Enter key handlers
document.getElementById("singleSearchInput").addEventListener('keypress', (e) => {
  if (e.key === 'Enter') document.getElementById("singleSearchBtn").click();
});

loginPassword.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') document.getElementById("loginBtn").click();
});

// Delete import for deleteDoc (was missing)
import { deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
</script>
</body>
</html>
