<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Delivery Map Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Segoe UI,Arial;background:#f5f7fb;}
.topbar{background:#111;color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:600;}
.container{max-width:1100px;margin:auto;padding:20px;}
.card{background:#fff;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
input,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:6px;font-size:14px;}
button{padding:10px 15px;border:none;border-radius:6px;background:#111;color:#fff;cursor:pointer;margin-right:5px;}
button:hover{background:#333;}
#map{height:420px;border-radius:10px;}
.success{color:green;font-weight:600;}
.error{color:red;font-weight:600;}
.hidden{display:none;}
.flex{display:flex;gap:10px;flex-wrap:wrap;}
.flex button{flex:1;}
</style>
</head>
<body>

<div class="topbar">ðŸšš Delivery Map Pro</div>

<div class="container">

<div id="authCard" class="card">
<h3>Login</h3>
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<div class="flex">
<button id="loginBtn">Login</button>
<button id="registerBtn">Register</button>
</div>
<div id="authMsg"></div>
</div>

<div id="app" class="hidden">

<div class="card">
<div class="flex">
<button id="logoutBtn">Logout</button>
</div>
<h3>Add / Update Delivery</h3>
<input type="text" id="mobileInput" placeholder="Mobile Number">
<input type="text" id="addressInput" placeholder="Full Address">
<select id="statusSelect">
<option value="Pending">Pending</option>
<option value="Delivered">Delivered</option>
<option value="Returned">Returned</option>
</select>
<input type="text" id="noteInput" placeholder="Note">

<div class="flex">
<button id="saveBtn">Save / Update</button>
<button id="deleteBtn">Delete</button>
</div>
<div id="saveMsg"></div>
</div>

<div class="card">
<h3>Search (Single)</h3>
<input type="text" id="searchInput" placeholder="Mobile Number">
<button id="searchBtn">Search</button>
</div>

<div id="map"></div>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyA82YWF574aCnkYdwN0airAcFl-_M21sHM",
authDomain: "delivery-map-pro.firebaseapp.com",
projectId: "delivery-map-pro",
storageBucket: "delivery-map-pro.firebasestorage.app",
messagingSenderId: "544868009171",
appId: "1:544868009171:web:005b3e95248eac940b8026"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let map;
let userMarker;
let deliveryMarker;

const authCard = document.getElementById("authCard");
const appDiv = document.getElementById("app");

const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const authMsg = document.getElementById("authMsg");

const mobileInput = document.getElementById("mobileInput");
const addressInput = document.getElementById("addressInput");
const statusSelect = document.getElementById("statusSelect");
const noteInput = document.getElementById("noteInput");
const saveMsg = document.getElementById("saveMsg");

function initMap(){
map = L.map('map').setView([23.8103,90.4125],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

navigator.geolocation.getCurrentPosition(pos=>{
let lat = pos.coords.latitude;
let lng = pos.coords.longitude;
userMarker = L.marker([lat,lng]).addTo(map)
.bindPopup("ðŸ“ Your Location").openPopup();
map.setView([lat,lng],14);
});
}

onAuthStateChanged(auth,user=>{
if(user){
authCard.classList.add("hidden");
appDiv.classList.remove("hidden");
setTimeout(initMap,200);
}else{
authCard.classList.remove("hidden");
appDiv.classList.add("hidden");
}
});

document.getElementById("loginBtn").onclick = async ()=>{
try{
await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
authMsg.innerHTML="<div class='success'>Login Successful</div>";
}catch(e){
authMsg.innerHTML="<div class='error'>"+e.message+"</div>";
}
};

document.getElementById("registerBtn").onclick = async ()=>{
try{
await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
authMsg.innerHTML="<div class='success'>Registered Successfully</div>";
}catch(e){
authMsg.innerHTML="<div class='error'>"+e.message+"</div>";
}
};

document.getElementById("logoutBtn").onclick = ()=>signOut(auth);

document.getElementById("saveBtn").onclick = async ()=>{
try{
if(!mobileInput.value || !addressInput.value){
saveMsg.innerHTML="<div class='error'>Fill all fields</div>";
return;
}

let lat = userMarker ? userMarker.getLatLng().lat : null;
let lng = userMarker ? userMarker.getLatLng().lng : null;

await setDoc(doc(db,"deliveries",mobileInput.value),{
address: addressInput.value,
status: statusSelect.value,
note: noteInput.value || "",
lat: lat,
lng: lng,
uid: auth.currentUser.uid,
updatedAt: Date.now()
});

saveMsg.innerHTML="<div class='success'>Saved Successfully âœ…</div>";
}catch(e){
saveMsg.innerHTML="<div class='error'>"+e.message+"</div>";
}
};

document.getElementById("deleteBtn").onclick = async ()=>{
await deleteDoc(doc(db,"deliveries",mobileInput.value));
saveMsg.innerHTML="<div class='success'>Deleted</div>";
};

document.getElementById("searchBtn").onclick = async ()=>{
let snap = await getDoc(doc(db,"deliveries",document.getElementById("searchInput").value));
if(!snap.exists()){alert("Not Found");return;}
let d = snap.data();

if(deliveryMarker) map.removeLayer(deliveryMarker);
deliveryMarker = L.marker([d.lat,d.lng]).addTo(map)
.bindPopup(d.address).openPopup();
map.setView([d.lat,d.lng],15);
};

</script>
</body>
</html>
